<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Land Measurement - Walk Mode</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }
    button {
      margin: 10px;
      padding: 10px 20px;
    }
    canvas {
      margin-top: 20px;
      border: 1px solid #000;
    }
  </style>
</head>
<body>
  <h2>Walk to Plot Corners</h2>
  <p>Walk to each corner and click "Mark Point". Minimum 3 points required.</p>
  <button onclick="markPoint()">Mark Point</button>
  <button onclick="drawFigure()">Draw Plot</button>
  <canvas id="plotCanvas" width="500" height="500"></canvas>

  <script>
    const points = [];
    const R = 6371000; // Earth radius in meters

    function toRad(x) {
      return (x * Math.PI) / 180;
    }

    function haversineDistance(lat1, lon1, lat2, lon2) {
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2) ** 2 +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function markPoint() {
      if (!navigator.geolocation) {
        alert("Geolocation is not supported by your browser");
        return;
      }
      navigator.geolocation.getCurrentPosition((pos) => {
        const { latitude, longitude } = pos.coords;
        points.push({ lat: latitude, lng: longitude });
        alert(`Point marked: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}`);
      });
    }

    function drawFigure() {
      if (points.length < 3) {
        alert("You need at least 3 points to draw a plot");
        return;
      }

      const canvas = document.getElementById("plotCanvas");
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const minLat = Math.min(...points.map(p => p.lat));
      const minLng = Math.min(...points.map(p => p.lng));
      const scale = 100000; // Rough scale for converting lat/lng to canvas

      const scaledPoints = points.map(p => ({
        x: (p.lng - minLng) * scale + 50,
        y: (p.lat - minLat) * -scale + 450
      }));

      ctx.beginPath();
      ctx.moveTo(scaledPoints[0].x, scaledPoints[0].y);

      for (let i = 1; i < scaledPoints.length; i++) {
        ctx.lineTo(scaledPoints[i].x, scaledPoints[i].y);
      }
      ctx.closePath();
      ctx.stroke();

      // Draw distances
      ctx.fillStyle = "blue";
      for (let i = 0; i < points.length; i++) {
        const p1 = points[i];
        const p2 = points[(i + 1) % points.length];
        const midX = (scaledPoints[i].x + scaledPoints[(i + 1) % points.length].x) / 2;
        const midY = (scaledPoints[i].y + scaledPoints[(i + 1) % points.length].y) / 2;
        const dist = haversineDistance(p1.lat, p1.lng, p2.lat, p2.lng);
        ctx.fillText(`${dist.toFixed(2)} m`, midX, midY);
      }
    }
  </script>
</body>
</html>
