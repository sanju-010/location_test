<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Land Measurement</title>
  <style>
    body {
      font-family: Arial, sans-serif;
    }

    #loader {
      display: none;
      font-weight: bold;
      color: red;
    }

    canvas {
      border: 1px solid #000;
      margin-top: 10px;
    }

    #coords {
      margin-top: 10px;
      font-size: 14px;
      max-height: 200px;
      overflow-y: auto;
    }

    button {
      padding: 10px 20px;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<h2>Land Measurement (Click & Plot)</h2>
<div id="loader">üìç Fetching GPS location...</div>
<canvas id="canvas" width="600" height="600"></canvas>

<div id="coords"></div>
<button onclick="getLocation()">üìç Add Point</button>

<script>
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const loader = document.getElementById('loader');
  const coordsDiv = document.getElementById('coords');

  const points = [];

  function getLocation() {
    if (!navigator.geolocation) {
      alert('Geolocation is not supported by your browser');
      return;
    }

    loader.style.display = 'block';

    navigator.geolocation.getCurrentPosition(success, error, {
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 0
    });
  }

  function success(position) {
    loader.style.display = 'none';
    const lat = position.coords.latitude;
    const lon = position.coords.longitude;

    coordsDiv.innerHTML += `<div>üìå ${points.length + 1}. Lat: ${lat.toFixed(6)}, Lon: ${lon.toFixed(6)}</div>`;

    points.push({ lat, lon });
    draw();
  }

  function error() {
    loader.style.display = 'none';
    alert('Unable to retrieve your location');
  }

  function distance(p1, p2) {
    const R = 6371000; // meters
    const œÜ1 = p1.lat * Math.PI / 180;
    const œÜ2 = p2.lat * Math.PI / 180;
    const ŒîœÜ = (p2.lat - p1.lat) * Math.PI / 180;
    const ŒîŒª = (p2.lon - p1.lon) * Math.PI / 180;

    const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
              Math.cos(œÜ1) * Math.cos(œÜ2) *
              Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

    return R * c;
  }

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (points.length < 1) return;

    // Normalize points to fit canvas
    const lats = points.map(p => p.lat);
    const lons = points.map(p => p.lon);
    const minLat = Math.min(...lats);
    const maxLat = Math.max(...lats);
    const minLon = Math.min(...lons);
    const maxLon = Math.max(...lons);

    const padding = 50;
    const scaleX = (canvas.width - 2 * padding) / (maxLon - minLon || 1);
    const scaleY = (canvas.height - 2 * padding) / (maxLat - minLat || 1);

    const plotPoints = points.map(p => ({
      x: padding + (p.lon - minLon) * scaleX,
      y: canvas.height - padding - (p.lat - minLat) * scaleY
    }));

    // Draw lines
    ctx.beginPath();
    ctx.moveTo(plotPoints[0].x, plotPoints[0].y);
    for (let i = 1; i < plotPoints.length; i++) {
      ctx.lineTo(plotPoints[i].x, plotPoints[i].y);
    }

    // Close shape if 3+ points
    if (plotPoints.length >= 3) {
      ctx.lineTo(plotPoints[0].x, plotPoints[0].y);
    }
    ctx.strokeStyle = '#007bff';
    ctx.lineWidth = 2;
    ctx.stroke();

    // Draw points
    ctx.fillStyle = 'red';
    plotPoints.forEach((p, i) => {
      ctx.beginPath();
      ctx.arc(p.x, p.y, 5, 0, 2 * Math.PI);
      ctx.fill();

      // Draw index
      ctx.fillStyle = 'black';
      ctx.fillText(i + 1, p.x + 8, p.y - 8);
      ctx.fillStyle = 'red';
    });

    // Draw distances
    ctx.fillStyle = 'black';
    for (let i = 0; i < points.length - 1; i++) {
      const midX = (plotPoints[i].x + plotPoints[i + 1].x) / 2;
      const midY = (plotPoints[i].y + plotPoints[i + 1].y) / 2;
      const dist = distance(points[i], points[i + 1]);
      ctx.fillText(`${dist.toFixed(2)}m`, midX + 5, midY - 5);
    }

    // Close shape distance
    if (points.length >= 3) {
      const i = points.length - 1;
      const midX = (plotPoints[i].x + plotPoints[0].x) / 2;
      const midY = (plotPoints[i].y + plotPoints[0].y) / 2;
      const dist = distance(points[i], points[0]);
      ctx.fillText(`${dist.toFixed(2)}m`, midX + 5, midY - 5);
    }
  }
</script>

</body>
</html>
