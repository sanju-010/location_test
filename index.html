<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Land Measurement</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 1rem;
      background-color: #f9f9f9;
      text-align: center;
    }

    #plotCanvas {
      border: 1px solid #333;
      margin-top: 1rem;
      background: #fff;
    }

    .btn {
      padding: 10px 20px;
      margin: 10px;
      font-size: 16px;
      cursor: pointer;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
    }

    .btn:disabled {
      background: #aaa;
      cursor: not-allowed;
    }

    #loader {
      display: none;
      font-size: 16px;
      margin-top: 10px;
      color: #555;
    }
  </style>
</head>
<body>
  <h2>Land Measurement - Walk & Record</h2>
  <p>Walk to each corner and press the button.</p>
  <button id="recordBtn" class="btn">üìç Record Corner</button>
  <button id="finishBtn" class="btn">‚úÖ Finish</button>
  <div id="loader">üì° Getting GPS coordinates...</div>
  <canvas id="plotCanvas" width="400" height="400"></canvas>

  <script>
    let points = [];
    const canvas = document.getElementById('plotCanvas');
    const ctx = canvas.getContext('2d');
    const recordBtn = document.getElementById('recordBtn');
    const finishBtn = document.getElementById('finishBtn');
    const loader = document.getElementById('loader');

    function toRadians(deg) {
      return deg * (Math.PI / 180);
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000; // Earth radius in meters
      const dLat = toRadians(lat2 - lat1);
      const dLon = toRadians(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(toRadians(lat1)) *
          Math.cos(toRadians(lat2)) *
          Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function drawPlot() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Translate GPS to relative coordinates
      const refLat = points[0].lat;
      const refLon = points[0].lon;

      const coords = points.map(p => {
        return {
          x: calculateDistance(refLat, refLon, refLat, p.lon),
          y: -calculateDistance(refLat, refLon, p.lat, refLon)
        };
      });

      // Auto scale to fit canvas
      const margin = 40;
      const minX = Math.min(...coords.map(p => p.x));
      const minY = Math.min(...coords.map(p => p.y));
      const maxX = Math.max(...coords.map(p => p.x));
      const maxY = Math.max(...coords.map(p => p.y));
      const scaleX = (canvas.width - 2 * margin) / (maxX - minX || 1);
      const scaleY = (canvas.height - 2 * margin) / (maxY - minY || 1);
      const scale = Math.min(scaleX, scaleY);

      const offsetX = margin - minX * scale;
      const offsetY = margin - minY * scale;

      ctx.beginPath();
      coords.forEach((p, i) => {
        const x = p.x * scale + offsetX;
        const y = p.y * scale + offsetY;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      // Close the shape
      const x0 = coords[0].x * scale + offsetX;
      const y0 = coords[0].y * scale + offsetY;
      ctx.lineTo(x0, y0);
      ctx.strokeStyle = "#007bff";
      ctx.lineWidth = 2;
      ctx.stroke();

      // Show distance labels
      ctx.fillStyle = "#000";
      coords.forEach((p, i) => {
        const p1 = coords[i];
        const p2 = coords[(i + 1) % coords.length];
        const dist = calculateDistance(
          points[i].lat, points[i].lon,
          points[(i + 1) % points.length].lat, points[(i + 1) % points.length].lon
        ).toFixed(2);
        const midX = (p1.x + p2.x) / 2 * scale + offsetX;
        const midY = (p1.y + p2.y) / 2 * scale + offsetY;
        ctx.fillText(`${dist} m`, midX, midY);
      });
    }

    function getCurrentLocation(callback) {
      if (!navigator.geolocation) {
        alert("Geolocation not supported.");
        return;
      }
      loader.style.display = 'block';
      recordBtn.disabled = true;
      navigator.geolocation.getCurrentPosition(position => {
        loader.style.display = 'none';
        recordBtn.disabled = false;
        callback({
          lat: position.coords.latitude,
          lon: position.coords.longitude
        });
      }, () => {
        loader.style.display = 'none';
        alert("Failed to get location.");
        recordBtn.disabled = false;
      }, {
        enableHighAccuracy: true
      });
    }

    recordBtn.addEventListener("click", () => {
      getCurrentLocation(pos => {
        points.push(pos);
        alert(`Point recorded: ${points.length}`);
      });
    });

    finishBtn.addEventListener("click", () => {
      if (points.length < 3) {
        alert("Need at least 3 points to draw a plot.");
        return;
      }
      drawPlot();
    });
  </script>
</body>
</html>
