<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Land Measurement App</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f9f9f9;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      margin-bottom: 10px;
    }
    #loader {
      display: none;
      margin: 10px 0;
      font-weight: bold;
      color: green;
    }
    #plot {
      margin-top: 20px;
    }
    svg {
      border: 1px solid #ccc;
      background: #fff;
    }
    .coord-log {
      font-size: 14px;
      background: #fff;
      border: 1px solid #ccc;
      padding: 10px;
      margin-top: 20px;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <h1>Land Measurement Tool</h1>
  <button onclick="recordPoint()">üìç Record Point</button>
  <div id="loader">Measuring location...</div>
  <div id="plot"></div>
  <div class="coord-log" id="coordLog"></div>

  <script>
    let coords = [];
    const plot = document.getElementById("plot");
    const loader = document.getElementById("loader");
    const coordLog = document.getElementById("coordLog");

    function recordPoint() {
      if (!navigator.geolocation) {
        alert("Geolocation is not supported by your browser");
        return;
      }

      loader.style.display = "block";

      navigator.geolocation.getCurrentPosition(
        position => {
          loader.style.display = "none";
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          coords.push([lat, lon]);

          const last = coords.length;
          coordLog.innerHTML += `<div><strong>Point ${last}:</strong> Lat: ${lat.toFixed(6)}, Lon: ${lon.toFixed(6)}</div>`;

          if (coords.length >= 2) {
            drawPolygon();
          }
        },
        error => {
          loader.style.display = "none";
          alert("Unable to retrieve your location");
        }
      );
    }

    function haversineDistance(coord1, coord2) {
      const R = 6371000; // Earth radius in meters
      const toRad = deg => (deg * Math.PI) / 180;
      const dLat = toRad(coord2[0] - coord1[0]);
      const dLon = toRad(coord2[1] - coord1[1]);

      const lat1 = toRad(coord1[0]);
      const lat2 = toRad(coord2[0]);

      const a = Math.sin(dLat / 2) ** 2 +
                Math.sin(dLon / 2) ** 2 * Math.cos(lat1) * Math.cos(lat2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function drawPolygon() {
      const distances = [];
      for (let i = 0; i < coords.length; i++) {
        const next = (i + 1) % coords.length;
        distances.push(haversineDistance(coords[i], coords[next]));
      }

      const maxDistance = Math.max(...distances);
      const scale = 300 / maxDistance; // scale to fit SVG

      const svgPoints = coords.map((c, i) => {
        const x = (i === 0) ? 0 : distances.slice(0, i).reduce((a, b) => a + b, 0) * scale;
        const y = i % 2 === 0 ? 50 : 100; // alternate y just for shape
        return { x, y };
      });

      let svgHTML = `<svg width="400" height="200">`;
      svgPoints.forEach((pt, i) => {
        const next = svgPoints[(i + 1) % svgPoints.length];
        svgHTML += `<line x1="${pt.x}" y1="${pt.y}" x2="${next.x}" y2="${next.y}" stroke="blue" stroke-width="2" />`;
        const dist = distances[i].toFixed(2);
        const labelX = (pt.x + next.x) / 2;
        const labelY = (pt.y + next.y) / 2 - 5;
        svgHTML += `<text x="${labelX}" y="${labelY}" font-size="12" fill="black">${dist} m</text>`;
      });
      svgHTML += `</svg>`;
      plot.innerHTML = svgHTML;
    }
  </script>
</body>
</html>
